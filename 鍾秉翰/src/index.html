<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>群組維護</title>
    <link rel="stylesheet" href="./style.css">

  </head>
    
  <body>
  <!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <title>群組範例</title>
    <link rel="stylesheet" href="./style.css">

  </head>
    
  <body>
  <!doctype html>

<!-- 在 <head> 中加入 SheetJS CDN -->
<script src="https://cdn.sheetjs.com/xlsx-0.19.1/package/dist/xlsx.full.min.js"></script>

<style>
 
</style>

<div id="app">

  <!-- ===== 主畫面 ===== -->
  <div class="page" id="page-main">
    <h1 class="rainbow-title">首件、自主群組維護-主畫面<br>系統網頁範例 部分功能無法使用</h1><br>
 

    <button  onclick="showAddGroupModal()">新增群組</button>
    
   <div id="addGroupModal" class="modal" style="display:none;">
  <div class="modal-content">
  <h3>新增群組</h3>
     <div class="modal-row">
    <label>機種代碼: <input id="modalMachine"></label><br>
    <label>新增數量: <input id="modalCount" type="number" value="1"></label><br>
    <label>沿用群組: <input id="modalCopyCode"></label>
    </div><br>
    <button class="btn-confirm" onclick="confirmAddGroup()">確定新增</button>
    <button class="btn-cancel" onclick="closeAddGroupModal()">取消</button>
  </div>
</div>
    
     <button  onclick="showPage('machine')">進入機台維護</button>
    <button  onclick="exportExcel()">匯出 Excel</button>
    <input type="file" id="importFile" onchange="importExcel(event)" accept=".xlsx,.xls"></table>
    <br><br>
    <a style="color: red; margin: 10px;" href="">PDA 前台表單link</a><a style="color: red;" href="">表單預覽測試</a><br><br>
    <label>篩選群組編碼: </label>
<input type="text" id="filterInput" placeholder="輸入群組編碼" oninput="filterGroups()">
    
    
    <label style="font-weight:bold; font-size:18px;">
  <input type="checkbox" id="toggleAll"> 全部隱藏 / 顯示

<br><br>
    <table>
      <thead>
        <tr>
          <th style="width: 10%;">群組編碼</th>
          <th style="width: 20%;">製程代碼</th>
          <th style="width: 30%;">項目 / 參數</th>
          <th style="width: 20%;">可作料號</th>
          <th style="width: 20%;">操作</th>
        </tr>
      </thead>
      <tbody id="main-table-body"></tbody>
    </table>
  </div>

  
  
  <!-- ===== 製程維護 ===== -->
  <div class="page" id="page-process">
    <h2>製程維護</h2>
    <button onclick="backToMain()">返回主畫面</button>
    <button onclick="addProcess()">新增製程</button>
    
<div id="processModal" class="modal-bg" style="display:none;">
  <div class="modal-box">
    <h3>批量新增製程</h3>
    <textarea id="processInput" placeholder="可用逗號或換行分隔多個製程代碼"></textarea>
    <div class="modal-btns">
      <button class="lux-btn" onclick="confirmProcess()">確認</button>
      <button class="lux-btn cancel-btn" onclick="closeProcessModal()">取消</button>
    </div>
  </div>
</div>
    
    
    
    
    <button onclick="importProcessFromGroup()">匯入其他群組製程</button>
    <table>
      <thead>
        <tr>
          <th>編號</th>
          <th>製程代碼</th>
          <th>機台編號</th>
          <th>修訂人員</th>
          <th>修訂時間</th>
          <th>刪除</th>
        </tr>
      </thead>
      <tbody id="process-table"></tbody>
    </table>
  </div>

  
  
  
  
  
  
 <!-- 機台維護頁面 -->
<div class="page" id="page-machine" style="display:none">
  <h2>機台維護</h2>
  <button onclick="backToMain()">返回主畫面</button>
 <button onclick="openMachineModal()">新增機台</button>
  <button onclick="exportMachineExcel()">匯出 Excel</button>
  <input type="file" id="importMachineFile" onchange="importMachineExcel(event)" style="display:inline-block;" /><br><br>
  <div id="machineFilter" style="margin-bottom:10px;">
  <select id="filterField">
    <option value="code">機台代碼</option>
    <option value="name">名稱</option>
    <option value="process">製程</option>
    <option value="work">工作</option>
    <option value="inspect">檢查</option>
  </select>
  <input type="text" id="filterKeyword" placeholder="輸入關鍵字">
  <button onclick="applyMachineFilter()">篩選</button>
  <button onclick="clearMachineFilter()">清除</button>
</div>

  <table border="1" cellpadding="5">
    
    <div id="machineModal" class="modal-bg" style="display:none;">
  <div class="modal-box">
    <h3>批量新增機台</h3>
    <textarea id="machineInput" placeholder="可用逗號或換行分隔多個機台代碼"></textarea>
    <div class="modal-btns">
      <button class="lux-btn" onclick="confirmMachine()">確認</button>
      <button class="lux-btn cancel-btn" onclick="closeMachineModal()">取消</button>
    </div>
  </div>
</div>

    
    
    <thead>
      <tr>
        <th>序號</th>
        <th>機台代碼</th>
        <th>名稱</th>
        <th>製程</th>
        <th>工作</th>
        <th>檢查</th>
        <th>刪除</th>
      </tr>
    </thead>
    <tbody id="machine-table"></tbody>
  </table>
</div> 
  
  
  
  
  
  
  
  
  
  <!-- ===== 項目/參數維護 ===== -->
  <div class="page" id="page-item">
    <h2>項目 / 參數維護</h2>
    <button onclick="backToMain()">返回主畫面</button>
    <button onclick="addItem()">新增項目</button>
    <button onclick="importItemsFromGroup()">匯入其他群組項目</button>

    <table>
      <p style="color: red;">手動=勾選時前端可變更參數
      <thead>
        <tr>
          <th>編號</th>
          <th>項目</th>
          <th>格式</th>
          <th>單位</th>
          <th>上限</th>
          <th>中間</th>
          <th>下限</th>
          <th>手動</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="item-table"></tbody>
    </table>
  </div>

  <!-- ===== 料號維護 ===== -->
  <div class="page" id="page-material">
    <h2>料號維護</h2>
    <button onclick="backToMain()">返回主畫面</button>
    <button onclick="addMaterial()">新增料號</button>
    
     <div id="materialModal" class="modal">
  <div class="modal-content">
    <h2>批量新增料號</h2>

    <textarea id="materialInput" placeholder="例如：1001410583,1001410584 或者一行一筆"></textarea>

    <div class="modal-btns">
      <button class="lux-btn" onclick="confirmMaterial()">確認</button>
      <button class="lux-btn" onclick="closeMaterialModal()">取消</button>
    </div>
  </div>
</div>
    
    
    
    
    
    <button onclick="importMaterialsFromGroup()">匯入其他群組料號</button>
    <table>
     
      <thead>
        <tr>
          <th>編號</th>
          <th>料號</th>
          <th>品名</th>
          <th>修訂人員</th>
          <th>修訂時間</th>
          <th>操作</th>
        </tr>
      </thead>
      <tbody id="material-table"></tbody>
    </table>
  </div>

</div>

<script>
  let machineFilterData = []; // 篩選後資料暫存
 function applyMachineFilter() {
  let field = document.getElementById("filterField").value;
  let keyword = document.getElementById("filterKeyword").value.trim().toLowerCase();

  if(!keyword){ renderMachine(); alert("請輸入關鍵字"); return; }

  machineFilterData = machineData.filter(m => 
    m[field] && m[field].toLowerCase().includes(keyword)
  );

  renderMachine(machineFilterData);
}

function renderMachine(data){
  let list = data || machineData; // 若傳入篩選資料就用它
  let tbody=document.getElementById('machine-table');
  tbody.innerHTML='';

  list.forEach((m,i)=>{
    let tr=document.createElement('tr');
    tr.dataset.index=i;

    tr.innerHTML = `
      <td>${i + 1}</td>
      <td contenteditable="true">${m.code}</td>
      <td contenteditable="true">${m.name}</td>
      <td contenteditable="true">${m.process}</td>
      <td contenteditable="true">${m.work}</td>
      <td contenteditable="true">${m.inspect}</td>
      <td><button class="delete-btn" onclick="deleteMachine(${i})">刪除</button></td>
    `;

    // 編輯欄位監聽
    tr.querySelectorAll('td[contenteditable="true"]').forEach((td, idx) => {
      td.addEventListener('input', () => {
        switch (idx) {
          case 0: // code 欄位
            let newCode = td.innerText.trim().toUpperCase();
            if (newCode === '') { td.innerText = m.code; return; }
            // 禁止重複
            if (machineData.some((x, j) => j !== i && x.code === newCode)) {
              alert('機台代碼重複！');
              td.innerText = m.code;
              return;
            }
            m.code = newCode;
            break;
          case 1: m.name = td.innerText.trim(); break;
          case 2: m.process = td.innerText.trim(); break;
          case 3: m.work = td.innerText.trim(); break;
          case 4: m.inspect = td.innerText.trim(); break;
        }
      });
    });

    // 拖拉功能
    tr.addEventListener('dragstart', e => {
      e.dataTransfer.setData("text/plain", i);
      tr.style.opacity = "0.5";
    });
    tr.addEventListener('dragend', () => { tr.style.opacity = "1"; });
    tr.addEventListener('dragover', e => e.preventDefault());
    tr.addEventListener('drop', e => {
      e.preventDefault();
      let fromIndex = parseInt(e.dataTransfer.getData("text/plain"));
      let toIndex = parseInt(tr.dataset.index);
      if (fromIndex === toIndex) return;
      let moved = machineData.splice(fromIndex, 1)[0];
      machineData.splice(toIndex, 0, moved);
      renderMachine();
    });

    tbody.appendChild(tr);
  });
}

// 打開彈窗
function openMachineModal() {
  document.getElementById("machineInput").value = "";
  document.getElementById("machineModal").style.display = "flex";
}

// 關閉彈窗
function closeMachineModal() {
  document.getElementById("machineModal").style.display = "none";
}

// 確認新增
function confirmMachine() {
  let input = document.getElementById("machineInput").value;
  if (!input) { alert("請輸入機台代碼"); return; }

  let list = input
    .split(/[\n,]+/)
    .map(v => v.trim().toUpperCase())
    .filter(v => v.length > 0);

  if (list.length === 0) { alert("沒有有效代碼！"); return; }

  // 過濾已存在
  let existing = machineData.map(m => m.code);
  list = list.filter(code => !existing.includes(code));

  if (list.length === 0) { alert("輸入的代碼都已存在！"); return; }

  list.forEach(code => {
    machineData.push({
      code: code,
      name: "",
      process: "",
      work: "",
      inspect: ""
    });
  });

  renderMachine();
  closeMachineModal();
}


// 刪除機台
function deleteMachine(i) {
  if (confirm("確定刪除這筆機台資料?")) {
    machineData.splice(i, 1);
    renderMachine();
  }
}

// 返回主頁面
function backToMain() {
  showPage("main"); // 假設你的主頁面函式名為 showPage
}

// 初始化
showPage("machine"); // 打開機台維護頁面
renderMachine();
  
  //
  // Excel 匯出
function exportMachineExcel(){
  if(typeof XLSX==='undefined'){ alert("請先引入 XLSX.js"); return; }
  let wb=XLSX.utils.book_new();
  let data=[["編號","機台代碼","名稱","製程","作業","檢驗"]];
  machineData.forEach((m,i)=>data.push([i+1,m.code,m.name,m.process,m.work,m.inspect]));
  XLSX.utils.book_append_sheet(wb,XLSX.utils.aoa_to_sheet(data),"機台資料");
  XLSX.writeFile(wb,"MachineData.xlsx");
}

// Excel 匯入
function importMachineExcel(event){
  if(typeof XLSX==='undefined'){ alert("請先引入 XLSX.js"); return; }
  let file=event.target.files[0];
  if(!file) return;
  let reader=new FileReader();
  reader.onload=function(e){
    let data=new Uint8Array(e.target.result);
    let wb=XLSX.read(data,{type:'array'});
    wb.SheetNames.forEach(sheet=>{
      let arr=XLSX.utils.sheet_to_json(wb.Sheets[sheet],{header:1});
      if(arr.length<2) return;
      arr.slice(1).forEach(r=>{
        let code=r[1];
        if(code && !machineData.some(m=>m.code===code)){
          machineData.push({code:code,name:r[2]||'',process:r[3]||'',work:r[4]||'',inspect:r[5]||''});
        }
      });
    });
    renderMachine();
  }
  reader.readAsArrayBuffer(file);
}

</script>
    
  </body>
  
</html>
    <script  src="./script.js"></script>

  </body>
  
</html>
